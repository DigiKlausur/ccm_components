/**
 * @overview ccm component for user authentication
 * @author Andr√© Kless <andre.kless@web.de> 2017-2019
 * @license The MIT License (MIT)
 * @version 9.2.0
 * @changes
 * version 9.2.0 (05.07.2019):
 * - uses Session Storage to remember user data
 * - throws error if you click on Abort in login area
 * - uses ccm v21.1.2
 * version 9.1.1 (29.05.2019):
 * - clears website area before redirect call
 * - uses ccm v20.7.1
 * version 9.1.0 (15.05.2019):
 * - login function returns user data
 * - uses ccm v20.4.0
 * version 9.0.1 (03.04.2019):
 * - bug fix for realm 'hbrsinfpseudo'
 * version 9.0.0 (11.02.2019):
 * - removed realm 'idento'
 * (for older version changes see ccm.user-8.3.1.js)
 */
(()=>{const d={name:"user",version:[9,2,0],ccm:"./ccm-21.1.3.min.js",config:{css:["ccm.load","https://ccmjs.github.io/akless-components/libs/bootstrap/css/bootstrap.css",{context:"head",url:"https://ccmjs.github.io/akless-components/libs/bootstrap/css/font-face.css"},"https://ccmjs.github.io/akless-components/user/resources/default.css"],html:{logged_in:{id:"logged_in",class:"well well-sm",inner:[{id:"user",inner:[{tag:"i",class:"fas fa-user"},"%user%"]},{id:"button",class:"btn btn-default btn-xs",inner:[{tag:"i",class:"fas fa-sign-out-alt"},"Logout"],onclick:"%click%"}]},logged_out:{id:"logged_out",class:"well well-sm",inner:{id:"button",class:"btn btn-default btn-xs",inner:[{tag:"i",class:"fas fa-sign-in-alt"},"Login"],onclick:"%click%"}},login:{id:"login-form",class:"container",inner:[{id:"loginbox",class:"card justify-content-center bg-light mt-5 col-6 p-0",inner:[{class:"card-header bg-info text-light",inner:"%title%"},{class:"card-body",inner:[{tag:"form",id:"loginform",role:"form",onsubmit:"%login%",inner:[{id:"username-entry",class:"input-group mb-3",inner:[{class:"input-group-prepend",inner:[{tag:"i",class:"input-group-text fas fa-user",id:"username-icon"}]},{tag:"input",id:"login-username",type:"text",class:"form-control",name:"user",placeholder:"Username",required:!0,"aria-label":"Username","aria-describedby":"username-icon"}]},{id:"password-entry",class:"input-group mb-3",inner:[{tag:"span",class:"input-group-prepend",inner:{tag:"i",class:"input-group-text fas fa-lock"}},{tag:"input",id:"login-password",type:"password",class:"form-control",name:"token",placeholder:"Password",required:!0,"aria-label":"Password","aria-describedby":"login-password"}]},{class:"form-group",inner:{class:"controls d-flex justify-content-between",inner:[{tag:"input",type:"submit",id:"btn-login",class:"btn btn-success text-light",value:"Login"},{tag:"a",id:"btn-abort",class:"btn btn-warning text-light",onclick:"%abort%",inner:"Abort"}]}}]}]}]}]}},realm:"guest",title:"Please enter username and password"},Instance:function(){const a=this;let b,c,d,e=this;this.init=async()=>{b=this.ccm.helper,c=b.privatize(this,"realm","store");for(let a=this;a=a.parent;)b.isInstance(a.user)&&a.user.getRealm()===this.getRealm()&&(e=a.user);e===this?(e=null,this.onchange=this.onchange?[this.onchange]:[]):this.onchange&&e.onchange.push(this.onchange)},this.ready=async()=>{(this.logged_in||sessionStorage.getItem("ccm-user-"+c.realm))&&(await this.login(!0)),this.logger&&this.logger.log("ready",b.privatize(this,!0))},this.start=async()=>(b.setContent(this.element,""),e)?e.start():void(this.logger&&this.logger.log("start",this.isLoggedIn()),this.norender||(this.isLoggedIn()?b.setContent(this.element,b.html(this.html.logged_in,{click:this.logout,user:d.user})):b.setContent(this.element,b.html(this.html.logged_out,{click:this.login})))),this.login=async f=>{async function g(c,d){return new Promise(e=>{function f(b){g&&(h[11===h.nodeType?"removeChild":"appendChild"](a.root),a.parent.element.style.removeProperty("display")),e(b)}const g=a.parent&&a.parent.element&&a.parent.element.parentNode,h=g?a.root.parentNode||document.createElement("div"):null;g&&(a.parent.element.style.display="none",g.appendChild(a.root)),b.setContent(a.element,b.html(a.html.login,{title:c,login:c=>{c.preventDefault(),f(b.formData(a.element))},abort:()=>f()})),d||b.removeElement(a.element.querySelector("#password-entry"))})}if(e)return e.login(this.onchange);if(this.isLoggedIn())return this.data();let h=sessionStorage.getItem("ccm-user-"+c.realm);if(h)h=b.parse(h);else do switch(c.realm){case"cloud":if(h=await g(this.title,!0),!h)throw await this.start(),new Error("login aborted");this.hash&&(h.token=this.hash.md5(h.token)),h.realm=c.realm,h.store=c.store;try{h=await this.ccm.load({url:this.url,params:h})}catch(a){h=void 0}break;case"guest":if(this.guest)h={user:!0===this.guest?b.generateKey():this.guest};else if(h=await g(this.title),!h)throw await this.start(),new Error("login aborted");h.token=h.user;break;case"hbrsinfkaul":h=await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/login.php",method:"JSONP",params:{realm:c.realm}}),b.isObject(h)&&(h.token=h.user+"#"+h.token);break;case"hbrsinfpseudo":h=await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/login_pseudonym.php",method:"JSONP",params:{realm:c.realm}}),b.isObject(h)&&(h.token=h.user+"#"+h.token);break;case"lea":if(h={user:sessionStorage.getItem("ccm@lea-user"),token:sessionStorage.getItem("ccm@lea-token")},!(b.isObject(h)&&h.user&&b.regex("key").test(h.user)&&"string"==typeof h.token))return alert("Authentication failed");break;default:if(h=await g(this.title,!0),!h)throw await this.start(),new Error("login aborted");h=await this.ccm.load({url:this.url,method:"POST",params:{realm:c.realm,user:h.user,token:h.token}});}while(!(b.isObject(h)&&h.user&&b.regex("key").test(h.user)&&"string"==typeof h.token)&&!alert("Authentication failed"));return d=b.clone(h),sessionStorage.setItem("ccm-user-"+c.realm,b.stringify(d)),this.logger&&this.logger.log("login"),await this.start(),!0!==f&&(await b.asyncForEach(this.onchange,async a=>a!==f&&(await a(this.isLoggedIn())))),d},this.logout=async a=>{if(e)return e.logout(this.onchange);if(this.isLoggedIn()){switch(c.realm){case"cloud":case"guest":break;case"hbrsinfkaul":case"hbrsinfpseudo":await this.ccm.load({url:"https://kaul.inf.h-brs.de/login/logout.php",method:"JSONP",params:{realm:c.realm}}).catch(()=>{});break;case"lea":sessionStorage.removeItem("ccm@lea-user"),sessionStorage.removeItem("ccm@lea-token");break;default:await this.ccm.load({url:this.url,method:"POST",params:{realm:c.realm,token:d.token}});}d=void 0,sessionStorage.removeItem("ccm-user-"+c.realm),this.logger&&this.logger.log("logout"),await this.start(),!0!==a&&this.onchange.forEach(b=>b!==a&&b(this.isLoggedIn()))}},this.isLoggedIn=()=>e?e.isLoggedIn():!!d,this.data=()=>e?e.data():b.clone(d),this.getRealm=()=>c.realm}};let e="ccm."+d.name+(d.version?"-"+d.version.join("."):"")+".js";if(window.ccm&&null===window.ccm.files[e])return window.ccm.files[e]=d;(e=window.ccm&&window.ccm.components[d.name])&&e.ccm&&(d.ccm=e.ccm),"string"==typeof d.ccm&&(d.ccm={url:d.ccm});let f=(d.ccm.url.match(/(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)/)||["latest"])[0];if(window.ccm&&window.ccm[f])window.ccm[f].component(d);else{var c=document.createElement("script");document.head.appendChild(c),d.ccm.integrity&&c.setAttribute("integrity",d.ccm.integrity),d.ccm.crossorigin&&c.setAttribute("crossorigin",d.ccm.crossorigin),c.onload=function(){window.ccm[f].component(d),document.head.removeChild(c)},c.src=d.ccm.url}})();
